<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>An Initial Exploration of DoS (Denial of Service) Attacks &#183; Alex's Blog</title><link rel=stylesheet href=/posts/css/style.css><link rel=stylesheet href=/posts/css/fonts.css><link rel=icon href=favicon.ico><link rel=icon type=image/png sizes=32x32 href=/posts/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/posts/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/posts/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title="Alex's Blog"></head><body><nav class=nav><div class=nav-container><a href=/posts/><h2 class=nav-title>Alex's Blog</h2></a><ul></ul></div></nav><main><div class=post><div class=post-info><span>Written by</span>
Alex<br><span>on&nbsp;</span><time datetime="2019-07-07 18:33:00 +1100 +1100">July 7, 2019</time></div><h1 class=post-title>An Initial Exploration of DoS (Denial of Service) Attacks</h1><div class=post-line></div><h2 id=background>Background</h2><p>Recently, while browsing internet, I came across a very interesting article titled <a href=https://www.freebuf.com/articles/es/205934.html>A Journey of Being Blackmailed by DDoS</a>. I read it in one breath, as if I were reading a story. As a backend programmer, I have long been aware of DoS attacks and I am very interested in the defense and attack techniques and principles in this area. This article reminded me of a series of articles I had read before about DoS, such as <a href=http://www.ruanyifeng.com/blog/2018/06/ddos.html>DDoS Attack Prevention Tutorial</a>, <a href=https://www.8btc.com/article/67111>DD4BC: A Hacker Group Specializing in DDoS Extortion for Bitcoin</a>, <a href=https://paper.seebug.org/938/>Linux Kernel SCTP Protocol Vulnerability Analysis and Reproduction (CVE-2019-8956)</a>, and <a href=https://www.anquanke.com/post/id/99608>GitHub Suffers Memcached-based DDoS Attack Scaling up to 1.35Tbps</a>. This time, I plan to conduct a systematic exploration of the DoS (including DDoS) area myself, and this article is a record of some of my explorations.</p><h2 id=what-are-dos-denial-of-service-and-ddos-attacks>What are DoS (Denial of Service) and DDoS attacks?</h2><p>Based on its literal meaning, my understanding is that any attack that disrupts the normal operation of a service, causing ordinary users to be unable to access the corresponding service, can be considered a DoS attack (Denial of Service Attack). This includes two types of attacks: &ldquo;winning by quantity&rdquo; and &ldquo;precision strike&rdquo;. Winning by quantity refers to consuming network and server resources through a large number of requests, as mentioned in the previous section, &ldquo;Preventing DDoS Attacks.&rdquo; The attack on GitHub based on Memcached, which reached a scale of 1.35Tbps, can be classified as this type. Precision strike, on the other hand, exploits vulnerabilities in a specific service, often causing the target service to crash with just a computer and a few commands, such as the example mentioned earlier, &ldquo;Analysis and Reproduction of the Linux Kernel SCTP Protocol Vulnerability (CVE-2019-8956).&rdquo;</p><p>However, most of the definitions I have seen so far refer to the &ldquo;winning by quantity&rdquo; type of attack. For example, on Security <a href=(https://www.secrss.com/articles/8872)>RSS</a>, the definition of DoS attack is:</p><blockquote><p>A DoS attack refers to attackers using reasonable service requests to occupy too many resources, causing the target system to be unable to provide normal services. This can be achieved by blocking various types of access requests: servers, devices, services, networks, applications, and even specific transactions within programs.</p></blockquote><p><a href=https://zh.wikipedia.org/wiki/%E9%98%BB%E6%96%B7%E6%9C%8D%E5%8B%99%E6%94%BB%E6%93%8A>wikipedia</a> defines DoS attacks as follows:</p><blockquote><p>A denial-of-service attack (DoS attack) is a cyber-attack in which the perpetrator seeks to make a machine or network resource unavailable to its intended users by temporarily or indefinitely disrupting services of a host connected to the Internet.</p></blockquote><p>This article mainly analyzes the &ldquo;winning by quantity&rdquo; type of attack. If there is a chance in the future, we will study the &ldquo;precision strike&rdquo; type of attack separately.</p><p>Since it is about winning by quantity, we cannot ignore DDoS (Distributed Denial of Service) attacks. Compared with DoS attacks, DDoS attacks may be more well-known, leading to these two terms being often used interchangeably. According to Wikipedia, when hackers use two or more compromised computers on the network as &ldquo;zombies&rdquo; to launch &ldquo;denial of service&rdquo;-style attacks against specific targets, it is called a distributed denial-of-service attack (DDoS attack).</p><h2 id=common-types-and-classification-of-ddos-attacks>Common Types and Classification of DDoS Attacks</h2><p>There are various techniques used in DDoS attacks, and it is necessary to classify them in order to better understand their characteristics. One common way of classifying them (as seen on the Chinese version of Wikipedia) is based on the type of resources consumed. There are two main types: attacks that target bandwidth consumption and attacks that target server resources (such as CPU, RAM, and disk space).</p><p>Bandwidth consumption attacks include:</p><ul><li>UDP Flood</li><li>ICMP Flood</li><li>&mldr;</li></ul><p>Resource consumption attacks include:</p><ul><li>TCP SYN Flood</li><li>Distributed HTTP Flood</li><li>&mldr;</li></ul><p>In my understanding, bandwidth consumption attacks are a &ldquo;brute force&rdquo; attack method that aims to consume the available bandwidth. Regardless of the type of service being provided, the attacker floods the network with traffic, causing the network bandwidth to be exhausted. Even if the service is still running, most legitimate requests from users will be unable to reach the server, resulting in a denial-of-service attack. Resource consumption attacks, on the other hand, are more &ldquo;sophisticated&rdquo; and focus on consuming specific server resources. For example, TCP SYN Flood, the most common DDoS attack, exploits a weakness in the TCP three-way handshake and can render a target server unresponsive with relatively low cost (more details can be found in the SYN Flood section of the article &ldquo;DDoS Attack Protection Experience Learned from Losing Hundreds of Thousands of Dollars&rdquo; at <a href=http://www.ijiandao.com/safe/cto/15952.html)>http://www.ijiandao.com/safe/cto/15952.html)</a>. Both types of attacks have their advantages and disadvantages. Bandwidth consumption attacks are relatively easy to implement, but require a large amount of traffic to bring a service to a &ldquo;denial of service&rdquo; state (usually achieved through overwhelming the network at the link layer with high volume attacks, as explained in Chapter 4 of the article &ldquo;On the Persistence of War: Entering the Tencent DDoS Protection System&rdquo; at <a href=https://security.tencent.com/index.php/blog/msg/71)>https://security.tencent.com/index.php/blog/msg/71)</a>. Resource consumption attacks, on the other hand, are more targeted and require less traffic to be effective.</p><p>In addition to classifying based on the type of resource consumption, DDoS attacks can also be classified based on the different network layers they attack. For example, AWS&rsquo;s whitepaper &ldquo;AWS Best Practices for DDoS Resiliency&rdquo; uses this classification to categorize DDoS attacks.</p><p><img src=https://i.imgur.com/QYDY8xa.png alt></p><p>In the whitepaper, attacks on layers 3 and 4 are classified as Infrastructure Layer Attacks, while attacks on layers 6 and 7 are classified as Application Layer Attacks. This classification is similar to the previous classification based on resource consumption. Infrastructure Layer Attacks, which are relatively low-level attacks, require a large amount of traffic to be effective, while higher-level attacks such as Application Layer Attacks do not require as much traffic. My understanding is that the higher the layer, the more system resources are required per unit of traffic. For example, at layers below 3, only bandwidth is consumed, but at layer 7, CPU, RAM, and even file handles (the system has a maximum number of file handles) are consumed. If any of these resources are insufficient, it can affect the stability of the service, or even cause it to be denied.</p><p>In addition to these two common classifications, I also saw another classification in a paper titled <a href=https://www.hindawi.com/journals/scn/2018/7178164/>DDoS-Capable IoT Malwares: Comparative Analysis and Mirai Investigation</a>. The authors of the paper believed that classifying based on the attacked network protocol is not accurate enough, as some DDoS attacks may involve more than one layer.</p><blockquote><p>&mldr; we will not consider that taxonomy since we believe that it is extremely inaccurate and hard to use (it is possible to have DDoS attacks which involve more than one protocol).</p></blockquote><p>The paper provides a very detailed classification of DDoS attacks, listing almost every possible type of attack, as shown in the <a href=https://www.hindawi.com/journals/scn/2018/7178164/fig1/>figure in the paper</a>:
<img src=https://i.imgur.com/rtOYG2h.png alt></p><h2 id=ddos-attack-cycle>DDoS Attack Cycle</h2><p>After discussing various methods of DDoS attacks, the question remains: how is a successful DDoS attack achieved? This brings us to the DDoS attack cycle. Firstly, for a DDoS attack to be successful, it needs to win with quantity, and the most important factor is collecting enough machines that can be used to launch the attack.</p><p>According to <a href=https://www.academia.edu/23981350/DDoS_attacks_and_defense_mechanisms_classification_and_state-of-the-art>DDoS attacks and defense mechanisms: classiﬁcationand state-of-the-art</a>, a DDoS attack generally goes through the following stages before the attack:</p><ol><li>Scanning for machines with vulnerabilities</li><li>Remotely infecting these machines through the vulnerabilities, making them part of a botnet</li><li>Communicating with these infected machines to confirm whether they are online or arranging for upgrades, etc.</li><li>Controlling these machines to launch a DDoS attack.</li></ol><p>As we can see, a significant part of the DDoS attack cycle involves collecting and infecting vulnerable machines, and the various methods of DDoS attacks mentioned earlier are just the final step to achieve this goal. In this regard, Mirai has been very successful. The following will use Mirai as an example and further analyze DDoS attacks from the source code level.</p><h3 id=mirai>Mirai</h3><p>Mirai is one of the most dangerous malware in recent years, infecting approximately 500,000 machines. Its target is mainly IoT devices with poor security and a large number of them, such as home routers, CCTV monitors, and so on.</p><p>Mirai&rsquo;s architecture mainly consists of four parts:</p><ol><li>CNC (Command and Control) server: Its main function is to receive user commands and send commands to the botnet (a network composed of infected machines).</li><li>Mirai bot: A single machine that constitutes the botnet. It includes three modules:
i). Scanning module: responsible for scanning vulnerable machines, once found, it will report to the reporting server
ii). Killer module: responsible for removing other malware on the machine, thus achieving exclusive control over the device
iii). Attack module: responsible for launching DDoS attacks</li><li>Reporting server: responsible for collecting vulnerable machine information from Mirai bot and forwarding it to the Loader server</li><li>Loader server:uploading malicious code to remote devices, thus achieving the goal of controlling the machines.</li></ol><p><img src=https://i.imgur.com/FjhUyBr.png alt></p><p>After understanding Mirai&rsquo;s main components and structure, let&rsquo;s take a look at its <a href=https://github.com/jgamblin/Mirai-Source-Code>source code</a>。</p><p>In DDoS attacks, I believe the two most important parts are Mirai&rsquo;s DDoS attack code and its code for scanning and infecting vulnerable machines. This article mainly analyzes the DDoS attack code, while for other parts, those interested can refer to this paper（<a href=https://www.hindawi.com/journals/scn/2018/7178164/>DDoS-Capable IoT Malwares: Comparative Analysis and Mirai Investigation</a>，which provides a detailed analysis and introduction to the source code.</p><p>Let&rsquo;s first take a look at the DDoS attack code, which is mainly located under the mirai/bot directory and named in the form of attack_xxx.c. Mirai mainly has four types of attack methods, with several attack methods in each category:</p><ol><li>udp(attack_udp.c)<ul><li>attack_udp_generic (Implement a slightly more complex UDP flood, but with greater flexibility)</li><li>attack_udp_vse （&ldquo;vse&rdquo; refers to Valve Source Engine, which is primarily targeted for attacks on game servers.）</li><li>attack_udp_dns （）</li><li>attack_udp_plain (The simplest UDP flood, with higher PPS than generic.)</li></ul></li><li>tcp(attack_tcp.c)<ul><li>attack_tcp_syn</li><li>attack_tcp_ack (<a href=http://blog.ddos-guard.ir/everything-about-tcp-ack-flood/>Everything About TCP ACK Flood</a>)</li><li>attack_tcp_stomp (<a href=https://www.imperva.com/blog/mirai-stomp-protocol-ddos/>How Mirai Uses STOMP Protocol to Launch DDoS Attacks</a>)</li></ul></li><li>gre(attack_gre.c)<ul><li>attack_gre_eth (<a href="https://www.imperva.com/blog/what-is-gre-tunnel/?utm_campaign=Incapsula-moved">GRE Tunnel for Humans: Making Sense of GRE</a>)</li><li>attack_gre_ip (GRE flood)</li></ul></li><li>app(attack_app.c)<ul><li>attack_app_proxy（not implemented）</li><li>attack_app_http</li><li>attack_app_cfnull</li></ul></li></ol><p>Due to space limitations, only the simplest attack in UDP, attack_udp_plain, will be analyzed here (the code has been simplified by removing the debug portion for ease of reading).</p><pre><code>void attack_udp_plain(uint8_t targs_len, struct attack_target *targs, uint8_t opts_len, struct attack_option *opts)
{
    int i;
    char **pkts = calloc(targs_len, sizeof (char *));
    int *fds = calloc(targs_len, sizeof (int));
    port_t dport = attack_get_opt_int(opts_len, opts, ATK_OPT_DPORT, 0xffff);
    port_t sport = attack_get_opt_int(opts_len, opts, ATK_OPT_SPORT, 0xffff);
    uint16_t data_len = attack_get_opt_int(opts_len, opts, ATK_OPT_PAYLOAD_SIZE, 512);
    BOOL data_rand = attack_get_opt_int(opts_len, opts, ATK_OPT_PAYLOAD_RAND, TRUE);
    struct sockaddr_in bind_addr = {0};

    // If no port is specified, a source port will be randomly chosen.
    if (sport == 0xffff)
    {
        sport = rand_next();
    } else {
        sport = htons(sport);
    }

    // create packets
    for (i = 0; i &lt; targs_len; i++)
    {
        struct iphdr *iph;
        struct udphdr *udph;
        char *data;

        // Allocate 65535 × 4 bytes of space for each packet.
        pkts[i] = calloc(65535, sizeof (char));

        // If no port is specified, randomly choose a destination port.
        if (dport == 0xffff)
            targs[i].sock_addr.sin_port = rand_next();
        else
            targs[i].sock_addr.sin_port = htons(dport);

        if ((fds[i] = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)) == -1)
        {
            return;
        }

        bind_addr.sin_family = AF_INET;
        bind_addr.sin_port = sport;
        bind_addr.sin_addr.s_addr = 0;

        bind(fds[i], (struct sockaddr *)&amp;bind_addr, sizeof (struct sockaddr_in));

        // For prefix attacks
        if (targs[i].netmask &lt; 32)
            targs[i].sock_addr.sin_addr.s_addr = htonl(ntohl(targs[i].addr) + (((uint32_t)rand_next()) &gt;&gt; targs[i].netmask));

        // Different from the &quot;connect&quot; function in TCP, &quot;connect&quot; in UDP does not actually establish a connection, but rather speeds up the sending process.
        connect(fds[i], (struct sockaddr *)&amp;targs[i].sock_addr, sizeof (struct sockaddr_in));
    }
    
    // After setting up all the packets, send the packet.
    while (TRUE)
    {
        for (i = 0; i &lt; targs_len; i++)
        {
            char *data = pkts[i];

            // Randomize packet content?
            if (data_rand)
                // If no length is specified, the default length of the data is 512
                rand_str(data, data_len);

            send(fds[i], data, data_len, MSG_NOSIGNAL);
        }
    }
}
</code></pre><p>From the analysis of the above source code, it can be seen that DDoS attacks are nothing more than constructing packets and sending them. The source code for other types of attacks is also similar. The key lies in what the protocol is in the middle.</p><h2 id=does-ddos-attack-have-a-distinction-between-advanced-and-low-level>Does DDoS attack have a distinction between advanced and low-level?</h2><p>Among so many DDoS attack methods, which one is the strongest and most threatening? Is it UDP attacks that can cause extremely high traffic, or HTTP floods that precisely target and consume service resources?</p><p>Using Mirai as an example, the book <a href=https://www.datacom.cz/userfiles/miraihandbookebook_final.pdf>《A Field Guide to Understanding IoT Attacks from the Mirai Botnet to Its Modern Variants》</a> provides detailed explanations of various attacks, including their bandwidth profile (mainly composed of BPS (bits per second) and PPS (packets per second)), and even ranks them based on threat index.</p><p><img src=https://i.imgur.com/TRF0Cw5.png alt></p><p>According to this report, DNS flood (attack_udp_dns) is the most threatening type of attack. This attack continuously sends a series of random subdomain (in the form of $STRING.domain.com) DNS queries, causing the target&rsquo;s name server to refuse service.
<img src=https://i.imgur.com/TdWzupo.png alt></p><p>The reason why it is difficult to defend against is that all traffic comes from normal DNS servers, making it difficult to distinguish between normal and attack traffic.</p><p>The second-ranked attack is VSE Flood. This attack mainly targets the Valve Source Engine game service. Due to design issues in the protocol, it is difficult to distinguish between normal and attack requests, making it difficult to prevent this type of DDoS attack.</p><p>The top two attacks are both UDP layer attacks, and both are attacks targeting specific services (DNS, game servers). The third-ranked STOMP is a TCP layer attack, and it is not targeted at a specific service. As long as there is a TCP connection, it can be attacked. Its attack method is to first lie in wait (establish a connection through a 3-way handshake), and then start wreaking havoc (PSH+ACK flood). The reason why it ranks in the top three is because this attack method can bypass some DDoS protections.</p><p>In the report, HTTP flood is ranked last. As a representative of precise attacks, the bps/pps of HTTP flood are the lowest among all attacks. But this is not the reason why it ranks low. In Mirai, there is only one simple HTTP attack method. This simple attack method does not require any user settings. This is why HTTP flood ranks last. Its power is not fully utilized in Mirai.</p><p>Based on the above analysis, in my opinion, the strongest DDoS attack depends on the specific scenario and the target of the attack. For example, for an attack targeting the Valve Source Engine service, VSE flood is the most threatening. As an aside, among so many traditional DDoS attacks, VSE flood is relatively unique because it targets a specific game server. I am curious why such an attack method exists. Perhaps game servers are easier to extort and have greater profits?</p><h2 id=ddos-attack-protection>DDoS Attack Protection</h2><p>As the saying goes, when you build a taller wall, the devil builds a taller ladder. The offense and defense of DDoS attacks always go hand in hand. Talking about attacks without discussing protection always feels incomplete. In this article, I mainly reference the &ldquo;AWS DDoS White Paper&rdquo;, &ldquo;On the Persistence of War - Entering the Tencent DDoS Protection System&rdquo;, and &ldquo;DDoS Attack Protection Experience Learned from Losing Tens of Thousands of Dollars!&rdquo;</p><p>In the face of attacks that can reach tens of GBps or even TBps, most companies rely on third-party DDoS protection systems such as Akamai, Cloudflare, and Cloudfront. The principle of protection is mainly to distribute a large number of requests to CDNs with some protective functions, so that a large number of requests cannot reach the source server. This requires a lot of network and machine resources, which most companies cannot afford.</p><p>As a leading global cloud service provider (Amazon invested in cloud services very early, reportedly 7 years ahead of other competitors), AWS has a complete set of DDoS protection facilities from layer 4 to layer 7 of the network layer. The white paper mentions that Cloudfront, combined with AWS WAF, can protect against all attacks from layer 4 to layer 7. In addition, Amazon Route 53 (DNS system) can effectively distribute/restrict attack traffic. Even if some traffic passes through the network where the server is located, AWS also has a set of defense mechanisms. ELB (Elastic Load Balancing), API Gateway, VPC (Virtual Private Cloud), and auto-scaling EC2 can all effectively reduce the impact of DDoS attacks.</p><p><img src=https://i.imgur.com/ng7Cuyp.png alt></p><p>After reading the AWS white paper, I feel that my understanding of DDoS protection is still relatively vague. Anyway, using the services of others is enough, and we don&rsquo;t need to understand or manage many underlying protections (this is also a feature of cloud services, where cloud service providers have already done a lot of basic work). In the &ldquo;On the Persistence of War - Entering the Tencent DDoS Protection System&rdquo;, the author summarizes a set of defense countermeasures and suggestions for DDoS attacks. I fully agree with the 6th point - returning to the essence and serving the business. Truly powerful DDoS attacks are difficult to prevent because they target specific business attributes (it is difficult to distinguish normal traffic from attack traffic). As mentioned earlier, attacks on DNS and VES are so effective because of the vulnerabilities in their own design. Therefore, better protection must be based on the characteristics of the business (because powerful DDoS attacks can also disguise themselves as normal traffic based on business characteristics).</p><p>The author of &ldquo;DDoS Attack Protection Experience Learned from Losing Tens of Thousands of Dollars!&rdquo; is an experienced veteran, with 15 years of DDoS attack protection experience. The article contains many attack analyses and defense strategies, and delves into their principles. I recommend reading it, but I won&rsquo;t go into detail here. According to his recommendation, CF (Cloudflare) DDoS protection service is very good.</p><h2 id=summary>Summary</h2><p>DDoS attack protection is a vast and profound field. It&rsquo;s challenging to get a comprehensive understanding of it in a short article (I have come across a lot of DDoS-specific terms in a short amount of time). Whether it&rsquo;s an attack or defense, there are still many areas to learn and explore, and many places to dig deeper. I believe there will be more new DDoS attack and defense techniques in the future, but by then, I won&rsquo;t be completely in the dark. Exploring DDoS attack protection for the first time in a more systematic way is still very interesting. Next, I will continue to study and explore the critical aspects of DDoS - scanning and infecting vulnerable machines.</p><h2 id=reference>Reference</h2><ol><li><a href=https://www.freebuf.com/articles/es/205934.html>https://www.freebuf.com/articles/es/205934.html</a></li><li><a href=http://www.ruanyifeng.com/blog/2018/06/ddos.html>http://www.ruanyifeng.com/blog/2018/06/ddos.html</a></li><li><a href=https://www.8btc.com/article/67111>https://www.8btc.com/article/67111</a></li><li><a href=https://paper.seebug.org/938/>https://paper.seebug.org/938/</a></li><li><a href=https://www.anquanke.com/post/id/99608>https://www.anquanke.com/post/id/99608</a></li><li><a href=https://www.secrss.com/articles/8872>https://www.secrss.com/articles/8872</a></li><li><a href=https://zh.wikipedia.org/wiki/%E9%98%BB%E6%96%B7%E6%9C%8D%E5%8B%99%E6%94%BB%E6%93%8A>https://zh.wikipedia.org/wiki/%E9%98%BB%E6%96%B7%E6%9C%8D%E5%8B%99%E6%94%BB%E6%93%8A</a></li><li><a href=http://www.ijiandao.com/safe/cto/15952.html>http://www.ijiandao.com/safe/cto/15952.html</a></li><li><a href=https://security.tencent.com/index.php/blog/msg/71>https://security.tencent.com/index.php/blog/msg/71</a></li><li><a href=https://d1.awsstatic.com/whitepapers/Security/DDoS_White_Paper.pdf>https://d1.awsstatic.com/whitepapers/Security/DDoS_White_Paper.pdf</a></li><li><a href=https://www.academia.edu/23981350/DDoS_attacks_and_defense_mechanisms_classification_and_state-of-the-art>https://www.academia.edu/23981350/DDoS_attacks_and_defense_mechanisms_classification_and_state-of-the-art</a></li><li><a href=https://www.cloudflare.com/press-releases/2018/cloudflare-named-a-leader-in-idc-marketscape-ddos-prevention-solutions/>https://www.cloudflare.com/press-releases/2018/cloudflare-named-a-leader-in-idc-marketscape-ddos-prevention-solutions/</a></li></ol></div><div class=pagination><a href=/posts/quickjs/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2023-07-12 11:59:10.521410278 +0000 UTC m=+0.049980790">2023</time> Alex. Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>