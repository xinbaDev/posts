<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Uber's Study on Data Race Patterns in Go &#183; Alex's Blog</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=icon href=favicon.ico><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title="Alex's Blog"></head><body><nav class=nav><div class=nav-container><a href=/><h2 class=nav-title>Alex's Blog</h2></a><ul><li><a href=/posts><span>Posts</span></a></li></ul></div></nav><main><div class=post><div class=post-info><span>Written by</span>
Alex<br><span>on&nbsp;</span><time datetime="2022-07-17 10:27:22 +1100 +1100">July 17, 2022</time></div><h1 class=post-title>Uber's Study on Data Race Patterns in Go</h1><div class=post-line></div><p>Recently, while browsing the Uber technology blog, I came across an interesting article titled &ldquo;Data Race Pattern in Go&rdquo;. The article classifies data race situations that are easy to occur in all of Uber&rsquo;s GO projects. I am familiar with data race, which can occur when reading and writing to the same data concurrently if not handled properly. I had heard that Go has data race issues, but I didn&rsquo;t have a clear example. Moreover, Uber is a large company, and I remember that many of its projects, such as the open-source project Zap and the distributed monitoring project Jaeger, are written in Go. So, I was interested in Uber&rsquo;s analysis of its actual Go projects.</p><p>This time, Uber summarized seven major situations/classifications that are prone to data races. Here, I will briefly introduce some data races that I am interested in. In the first category, the index variable in the loop is not properly privatized. Specifically, calling a go routine inside a loop and then using the index variable in the go routine is a common mistake. There are also some interesting data races, such as assuming that maps are thread-safe because map operations appear to be simple assignments/reads. However, assigning a value to a key in a map can affect other keys in the same map, leading to data races. Therefore, using a map in multi-threading requires locking. In addition, incorrect use of add/done functions in sync.WaitGroup can also lead to data races.</p><p>In general, calling go routines in loops requires great caution, otherwise data races are likely to occur. The author also did some statistics, and the most common type of data race is concurrent slice access. Specifically, accessing a slice without locking in a multi-concurrency situation. A slice is a special type of data structure, and its metadata is copied to the stack when passed, rather than just passing a pointer. This can also cause data races. Another noteworthy situation that can cause data races is passing a mutex incorrectly. If a reference should be passed, but a value is passed instead, this can also cause data races. Due to Go&rsquo;s design, this type of incorrect passing is also considered valid. This situation does not occur in Rust.</p><p>In summary, there are many opportunities for data races to occur in Go, and some are not easy to detect, especially when rushing to write code. After an error occurs, data race errors are not easy to detect, and they may not appear immediately at runtime. Fixing them is very troublesome. Rust is much stronger in this regard because its design is aimed at avoiding data race situations. If there is code that may produce data races, it will not even compile. Of course, writing Rust code may not be as enjoyable as writing Go code because it requires considering memory-related issues while writing application logic. On the other hand, writing Go code is not as enjoyable as writing Python code because it requires considering variable types. It can be seen that programming languages are becoming increasingly abstract from the beginning, and there is a trend in recent years toward a return to the lower-level languages like C. Even Linux is considering rewriting the operating system in Rust.</p></div><div class=pagination><a href=/posts/server/ class="left arrow">&#8592;</a>
<a href=/posts/emailspoofincident/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2023-07-11 10:42:12.040922767 +0000 UTC m=+0.042831551">2023</time> Alex. Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>