<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>A Record of Email Spoofing &#183; Alex's Blog</title><link rel=stylesheet href=/posts/css/style.css><link rel=stylesheet href=/posts/css/fonts.css><link rel=icon href=favicon.ico><link rel=icon type=image/png sizes=32x32 href=/posts/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/posts/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/posts/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title="Alex's Blog"></head><body><nav class=nav><div class=nav-container><a href=/posts/><h2 class=nav-title>Alex's Blog</h2></a><ul></ul></div></nav><main><div class=post><div class=post-info><span>Written by</span>
Alex<br><span>on&nbsp;</span><time datetime="2023-01-09 13:49:22 +1100 +1100">January 9, 2023</time></div><h1 class=post-title>A Record of Email Spoofing</h1><div class=post-line></div><p>Recently, one of the company&rsquo;s email accounts was impersonated and used to send a lot of spam emails. Because the emails were sent in the middle of the night, it wasn&rsquo;t discovered until the next morning. The mailbox was filled with failed delivery emails from the postmaster. At first, it was thought that the email account had been hacked, so the password was reset. But later, this possibility was ruled out because the company&rsquo;s email accounts had already enabled two-factor authentication, which meant that even if a hacker had obtained the password, they wouldn&rsquo;t be able to log in. Upon closer inspection, it was found that almost all of the emails that failed SPF authentication came from strange domains like 1agqewQ5HVuo.kasegpexve1agqewQ5HVuo.com.au, which suggested that the email account had been impersonated. After checking the message ID of the returned emails in Microsoft Exchange, it was confirmed that the emails were not sent from the company&rsquo;s Outlook account. The conclusion was that the account had been impersonated.</p><p>In fact, email impersonation is quite common because email headers are not encrypted. Years ago, I tried modifying the &ldquo;from&rdquo; field of an email to impersonate someone else&rsquo;s email account. I tested it on Gmail and it was almost indistinguishable from a real email. I even used another company&rsquo;s email domain when applying for a job, and the company&rsquo;s CEO called me to inquire about it. It shows how easy it is to impersonate an email account. However, I remember that Gmail has since improved its security and now flags impersonated emails. It&rsquo;s not surprising that email impersonation happens frequently. What&rsquo;s strange is why the returned emails went to our regular inbox instead of the spam folder. They were mainly about the recipient&rsquo;s email DNS resolution failure or the recipient&rsquo;s email system refusing to establish a connection or not responding. I instinctively felt that these error emails shouldn&rsquo;t be sent to our inbox, so I contacted Microsoft Support, but the engineer who took over the case didn&rsquo;t seem to understand the issue and even suspected that the <a href=mailto:postmaster@outlook.com>postmaster@outlook.com</a> email account was doing something wrong, not realizing that it was a system email account. After a day, the number of emails sent by postmaster decreased, but I&rsquo;m not sure if Microsoft made any changes.</p><p>Just when I thought it had ended, a few days ago, we found that our company&rsquo;s Outlook email account suddenly couldn&rsquo;t send emails to Gmail. Many of our clients use Gmail to contact us, so not being able to send emails to Gmail would have a big impact on our business. If the previous influx of returned emails wasn&rsquo;t an accident, then not being able to send emails to Gmail was definitely a problem. After receiving a message from a colleague, I immediately did a test by sending an email from our company&rsquo;s email account to my own Gmail account, and it was blocked. I knew it was going to be trouble because Gmail was treating our emails as spam and blocking them, and there was nothing we could do to control it. After all, Gmail&rsquo;s spam filter criteria are not public, and it&rsquo;s difficult to contact Google to unblock the email account. According to what I read online, it would take at least a week or two to unblock the email account.</p><p>After receiving a notification that my email was returned by Gmail, I saw an error report of 550 5.7.1, indicating that it was considered spam due to a very low domain reputation. However, after testing with Google&rsquo;s postmaster and third-party tools, I found that there was no problem with the domain&rsquo;s reputation. The only thing that concerned me was that on the day my email was compromised last month, the domain reputation was medium in postmaster. I continued testing and found that only Gmail couldn&rsquo;t receive my emails. Other email providers like iCloud and ProtonMail could receive emails sent from Outlook without any issues. It seemed that Gmail only had restrictions on emails sent from Outlook. All of this made me think that domain reputation might not be the real or primary reason for the issue. Instead, the email provider used to send the emails has a significant impact. During my testing, I also came across a tool for testing email quality called MX Toolbox. By sending an email to <a href=mailto:ping@mxtoolbox.com>ping@mxtoolbox.com</a>, you can see some configuration problems with your email. There are also many other useful tools on the website. Through this tool, I found that our DKIM on Outlook was not aligned, meaning that the signing domain and the sending email domain were not the same. DKIM uses asymmetric encryption to ensure that the email content is not modified. If you do not set it up specifically, Microsoft will use its own key to encrypt it. There was also a lack of DMARC records. This record relies on SPF and DKIM, and DMARC is only useful if these two are enabled. It is mainly used to tell the email receiver how to handle emails that do not meet the conditions and to provide an email address to receive the situation of sending emails. My understanding of DMARC is that this record can help email receivers better handle spam, and as a sender, you can also receive feedback on email sending situations. MX Toolbox pointed out these two shortcomings, and according to some online sources, they can help improve email quality and reduce the possibility of being marked as spam. Unfortunately, after testing, there was no immediate effect, and sending emails from Outlook to Gmail still could not get through. I noticed on MX Toolbox that our Outlook email server was blacklisted when sending emails. So, I suspected that this was the problem, and I contacted Microsoft Support again to ask how to remove the blacklist. The engineer who took over wasn&rsquo;t very clear. After I described my situation, he took a lot of screenshots and promised to consult with senior engineers and reply to me next Monday, as it was already Friday after work.</p><p>But of course I couldn&rsquo;t wait, so I continued testing. I found that on other platforms that test blacklists, our email domain had no issues. However, when I used my personal Outlook email to send an email to mxtoolbox, it also showed up on the blacklist, even though I could send emails to Gmail with my personal email just fine. This made me question the reliability of the blacklist on mxtoolbox. Overall, through continuous testing and research, I always found conflicting evidence, making it difficult for me to analyze. Even after making sure I had done everything to improve email quality, I still got blocked by Gmail. I submitted a report to Google and sent them the email headers of the emails that were wrongly marked as spam by Gmail. However, I couldn&rsquo;t just wait for Google to unblock me since not being able to contact clients for even a day could lead to losses. I had previously discovered that third-party email service providers could send emails to Gmail just fine, but those were only used for sending emails and did not provide an email inbox. So, I also opened an email service on Google Workplace and after modifying and adding SPF, DKIM and other information, I found that Gmail could receive the emails I sent. This solved the problem of sending emails. The remaining issue was how to synchronize the emails on Outlook and Gmail. Since Outlook was still receiving the emails, I needed a way to transfer them to Gmail. Most of the methods I found were for transferring emails between different email addresses and were not suitable for our situation of having the same email address. I tried many methods, such as using the import function in Gmail&rsquo;s settings, but I couldn&rsquo;t verify my Outlook email no matter what I did, even after disabling the two-factor authentication. Finally, I was able to do it using the gwsmo+Outlook desktop method provided by Google. The principle was to log in to both Gmail and Outlook email on Outlook at the same time, add a redirect rule, and transfer each email received by Outlook to a local folder in Gmail. Then the gwsmo plugin would periodically synchronize Gmail. This way, I could receive emails on Gmail. After getting this done, I finally felt relieved and in control again.</p><p>On Monday when I was working, Microsoft Support sent me an email saying that their senior engineers were replying slowly lately and apologized for the inconvenience. However, I wasn&rsquo;t in a hurry at that point and didn&rsquo;t have high expectations for Microsoft Support. On Tuesday, they called me and said that I needed to apply to a third-party to remove my email address from the blacklist. I thanked them and said we could close the case because by that time, I had already been able to send emails from Outlook to Gmail normally again. I guess the Gmail algorithm for detecting spam emails has some time-dependent parameters, so it takes some time to unblock the email. This incident gave me a better understanding of email verification. When I took over, the company&rsquo;s email server had already been set up, and Microsoft automatically adds SPF from the beginning. So, I always thought there was no problem. However, it seems that Microsoft&rsquo;s email security is not great, and this type of attack can be used on all Outlook emails with initial settings.</p></div><div class=pagination><a href=/posts/datarace/ class="left arrow">&#8592;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2023-07-11 11:18:56.291663668 +0000 UTC m=+0.043582185">2023</time> Alex. Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>