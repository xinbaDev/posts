<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>An incident of Email Spoofing &#183; Alex's Blog</title><link rel=stylesheet href=/posts/css/style.css><link rel=stylesheet href=/posts/css/fonts.css><link rel=icon href=favicon.ico><link rel=icon type=image/png sizes=32x32 href=/posts/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/posts/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/posts/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title="Alex's Blog"></head><body><nav class=nav><div class=nav-container><a href=/posts/><h2 class=nav-title>Alex's Blog</h2></a><ul></ul></div></nav><main><div class=post><div class=post-info><span>Written by</span>
Alex<br><span>on&nbsp;</span><time datetime="2023-01-09 13:49:22 +1100 +1100">January 9, 2023</time></div><h1 class=post-title>An incident of Email Spoofing</h1><div class=post-line></div><p>Recently, one of our company&rsquo;s email accounts was impersonated, leading to the sending of a large number of spam emails. Unfortunately, we didn&rsquo;t discover this until the following morning because the emails were sent during the night. Upon realizing the issue, we found our mailbox flooded with failed delivery emails from the postmaster. Initially, we suspected a hack and promptly reset the account&rsquo;s password. However, it turned out that our email accounts already had two-factor authentication enabled, making it unlikely that a hacker could gain access.</p><p>Further investigation revealed that most of the emails failing SPF authentication came from strange domains like 1agqewQ5HVuo.kasegpexve1agqewQ5HVuo.com.au, indicating impersonation. After checking the message IDs of the returned emails in Microsoft Exchange, we confirmed they were not sent from our Outlook account. Therefore, it was clear that our account had been impersonated.</p><p>Email impersonation is a common occurrence due to the lack of encryption in email headers. I personally experimented with modifying the &ldquo;from&rdquo; field of an email in the past and found it difficult to distinguish the fake email from a genuine one, especially in Gmail. However, Gmail has since improved its security and now flags impersonated emails.</p><p>The strange part of this incident was that the returned emails ended up in our regular inbox rather than the spam folder. These emails mostly reported recipient email DNS resolution failures or issues with establishing connections or receiving responses. It felt instinctively wrong for these error emails to land in our inbox, so I contacted Microsoft Support. Unfortunately, the assigned engineer seemed to misunderstand the issue and even suspected our system email account, <a href=mailto:postmaster@outlook.com>postmaster@outlook.com</a>, of wrongdoing. It took some time, but the number of emails sent by postmaster eventually decreased.</p><p>Just when I thought the problem was resolved, a few days ago, we discovered that our company&rsquo;s Outlook email account suddenly couldn&rsquo;t send emails to Gmail. Since many of our clients use Gmail to contact us, this issue had a significant impact on our business. I conducted a test by sending an email from our company&rsquo;s account to my personal Gmail, and it was blocked. This was troubling because Gmail was flagging our emails as spam and blocking their delivery, and there was little we could do to control it. It was challenging to contact Google and resolve the email account blockage since their spam filter criteria are not publicly disclosed. According to my online research, it could take up to a week or two to unblock the account.</p><p>When I received a notification that my email was returned by Gmail, the error report indicated that it was considered spam due to a low domain reputation (error code: 550 5.7.1). However, testing with Google&rsquo;s postmaster and third-party tools showed that our domain&rsquo;s reputation was not an issue. I noticed that on the day our email was compromised, the domain reputation was marked as &ldquo;medium&rdquo; in postmaster. I also found that only Gmail had restrictions on emails sent from Outlook, as other providers like iCloud and ProtonMail had no issues receiving our emails. This led me to believe that the email provider used to send the emails played a significant role. During my investigation, I came across a tool called MX Toolbox, which helped identify some configuration problems with our email setup. It highlighted two shortcomings: misalignment of our DKIM on Outlook and the absence of DMARC records. These issues, if addressed, could enhance email quality and reduce the likelihood of being marked as spam. However, despite taking corrective measures, the problem persisted, and Gmail continued to block our Outlook emails. Additionally, I discovered that our Outlook email server was blacklisted when sending emails, leading me to suspect it was the root cause. I contacted Microsoft Support again to seek guidance on removing the blacklist. After explaining the situation, the engineer assigned to my case took screenshots and promised to consult senior engineers, with a reply expected the following Monday.</p><p>Unable to wait, I continued my investigation and found that other platforms testing blacklists showed no issues with our email domain. Surprisingly, even when I used my personal Outlook email to send an email to mxtoolbox, it also appeared on the blacklist, despite my ability to send emails to Gmail using my personal email without any problems. This raised doubts about the reliability of the mxtoolbox blacklist. Throughout my testing and research, I encountered conflicting evidence, making it challenging to analyze the root cause. Despite ensuring that I had taken all necessary steps to improve email quality, Gmail continued to block our emails. I reported the issue to Google, providing them with the email headers of the incorrectly marked spam emails. However, I couldn&rsquo;t solely rely on Google to unblock our account, as even a day without being able to communicate with clients could result in losses. I previously discovered that third-party email service providers could successfully send emails to Gmail, but they only offered email sending functionality and lacked an email inbox. Consequently, I set up an email service using Google Workplace. After modifying and adding necessary information like SPF and DKIM, Gmail was able to receive the emails we sent. This resolved the problem of sending emails. The remaining challenge was synchronizing the emails between Outlook and Gmail. Since Outlook was still receiving emails, I needed a method to transfer them to Gmail. Most methods I found were designed for transferring emails between different email addresses, which didn&rsquo;t suit our situation of having the same email address. I tried various approaches, including using the import function in Gmail&rsquo;s settings, but I couldn&rsquo;t verify my Outlook email, even after disabling two-factor authentication. Finally, I managed to accomplish it using the gwsmo+Outlook desktop method provided by Google. The process involved logging in to both Gmail and Outlook accounts simultaneously using Outlook, adding a redirect rule, and transferring each email received by Outlook to a local folder in Gmail. Periodic synchronization through the gwsmo plugin ensured that I could receive emails on Gmail. Once this was achieved, I finally felt relieved and regained control.</p><p>On Monday, while I was working, I received an email from Microsoft Support, acknowledging that their senior engineers had been slow to respond recently and apologizing for the inconvenience. However, I wasn&rsquo;t in a hurry at that point and kind of lost confident in Microsoft Support. On Tuesday, they called me and suggested applying to a third-party to remove my email address from the blacklist. I thanked them but decided to close the case since, by that time, I had already regained the ability to send emails from Outlook to Gmail without any issues. I suspect that the Gmail algorithm for detecting spam emails includes time related parameters, which is why it took some time to unblock our email. This incident provided me with a better understanding of email verification. When I took over, the company&rsquo;s email server had already been set up by someone else, and Microsoft automatically added SPF from the beginning, so I assumed everything was fine. However, it seems that Microsoft&rsquo;s default email security setup is not enough, and DKIM and DMARC should be set to properlly prevent spoofing attack.</p></div><div class=pagination><a href=/posts/datarace/ class="left arrow">&#8592;</a>
<a href=/posts/chatgpt/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2023-07-12 12:32:33.673508943 +0000 UTC m=+0.050844647">2023</time> Alex. Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>